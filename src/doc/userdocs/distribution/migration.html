<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
                      
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
  <head>
    <title>Fedora Migration Guide</title>
    <link rel="stylesheet" type="text/css" href="../docstyle.css" />
  </head>

  <body>

    <div id="header">
      <a href="../../../index.html">
      </a>
      <h1>Fedora Migration Guide</h1>
      <h2>Fedora Release 3.0 Beta 1</h2>
    </div>

    <div id="toc">
      <h2>Table of Contents</h2>
      <ol>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#install-fedora">Install, Start, and Stop Fedora 3.0</a></li>
        <li><a href="#point">Point Fedora 3.0 to Existing Objects</a></li>
        <li><a href="#install-migration">Install the Migration Utilities</a></li>
        <li><a href="#analyzer">Run the Analyzer</a></li>
        <li><a href="#generator">Run the Generator</a></li>
        <li><a href="#transformer">Run the Transformer</a></li>
        <li><a href="#rebuilder">Run the Rebuilder</a></li>
        <li><a href="#ingest">Ingest Generated Objects</a></li>
        <li><a href="#verify">Verify Success and Clean Up</a></li>
      </ol>
    </div>
    
    <ol id="content">
    
      <li>
        <h2 id="overview">Overview</h2>
        <span class="plaintext">
          This document explains how to migrate your Fedora repository from 
          version 2.x to 3.0.  Before continuing, you should familiarize 
          yourself with the new <a href="../digitalobjects/cmda.html">
          Content Model Architecture.</a>  A basic understanding of how the 
          CMA works will be helpful in understanding the migration process. 
          <br />
          <br />
          Throughout this guide, OLD_FEDORA_HOME refers to the home directory
          of your Fedora 2.x installation, and NEW_FEDORA_HOME refers to the
          home directory of your new Fedora 3.0 installation.
        </span>
      </li>
      
      <li>
        <h2 id="install-fedora">Install, Start, and Stop Fedora 3.0</h2>
        <span class="plaintext">
          Follow the instructions in the <a href="installation.html">
          Fedora Installation Guide.</a>.  When finished, start the server
          and verify your installation was successful by visiting the
          <em>describeRepository</em> page (e.g. 
          <a href="http://localhost:8080/fedora/describe">
          http://localhost:8080/fedora/describe</a>).  Finally, shut down
          Fedora.  It should not be restarted again until later in the
          migration process.
        </span>
      </li>
      
      <li>
        <h2 id="point">Point Fedora 3.0 to Existing Objects</h2>
        <span class="plaintext"></span>
        <ol class="alpha">
          <li> Object XML (FOXML)
            <span class="plaintext">
              Determine where your old object XML is stored.  If you're unsure,
              consult <code>OLD_FEDORA_HOME/server/config/fedora.fcfg</code>
              and find the value of <code>object_store_base</code>.
              <br/>
              <br/>
              Edit <code>NEW_FEDORA_HOME/server/fedora.fcfg</code> and change
              the value of <code>object_store_base</code> the <em>full path</em>
              of your old objects directory.
              <br/>
              <div class="notice">
                <strong>IMPORTANT:</strong> If you haven't already done so, 
                make a backup of all original object XML files.  These will be
                changed during the transformation part of the migration process,
                and if something goes wrong, this backup will be your only
                way of recovering.
              </div>
            </span>
          </li>
          <li> Managed Datastreams
            <span class="plaintext">
              Determine where your old Fedora instance stored managed
              datastreams.  Again, you can check your old <code>fedora.fcfg
              </code> file.  Look for the value of 
              <code>datastream_store_base</code>.
              <br/>
              <br/>
              Edit <code>NEW_FEDORA_HOME/server/fedora.fcfg</code> and change
              the value of <code>datastream_store_base</code> the 
              <em>full path</em> of your old datastreams directory.
              <br/>
              <br/>
              NOTE: The migration process will not make any changes to these
              files.
            </span>
          </li>
        </ol>
      </li>
      
      <li>
        <h2 id="install-migration">Install the Migration Utilities</h2>
        <span class="plaintext">
          The migration utilities come as a separate download from the 
          Fedora installation.  They are all included, with source, in a 
          single download <a href="http://sourceforge.net/project/showfiles.php?group_id=177054&package_id=219723">
          in the download area on sourceforge</a>.  Once unzipped, you will
          find the executable jars in the dist/ directory.
        </span>
      </li>
      
      <li>
        <h2 id="analyzer">Run the Analyzer</h2>
        <span class="plaintext">
          The analyzer examines all of your existing digital objects and 
          looks for similarities.  It outputs the following information in 
          a directory you specify.
        </span>
        <ul>
          <li> A set of generated content models.</li>
          <li> A list of PIDs for each content model.</li> 
          <li> Behavior Mechanism information for each content model.</li>
        </ul>
        <span class="plaintext">
          The analyzer does not make changes to any source objects.
        </span>
        <ol class="alpha">
          <li> Configuring the Analyzer
            <span class="plaintext">
              The analyzer accepts a Java properties file for configuration.
              <br/>
              <div class="notice"> 
                <strong>NOTE:</strong> In properties files, the "\" 
                character must be escaped.  When using Windows, this means
                paths like <code>c:\work\abc</code> must be written as 
                <code>c:\\work\\abc</code>.
              </div>
              Create a file (e.g. <code>migration.properties</code>) with the
              following content, filling in values appropriate to your
              environment:
              <br/>
              <code class="block">
<pre>
# This is the directory where the analyzer's output files should be sent.
# If it doesn't already exist, it will be automatically created.
# If it already exists, it must be empty (to avoid accidental overwrites)
# To disable the above restriction, uncomment clearOutputDir=true below.
outputDir=c:\\fedora-migration
#clearOutputDir=true
 
# The Fedora 3.0 home directory.
fedoraHome=c:\\fedora-3.0
 
# The full path to the JDBC driver Fedora is configured to use.
# NOTE: The analyzer only uses the database to aid in looking up
# the location of FOXML.  It will populate the initial paths in
# the database the first time it runs, if the necessary.
jdbcJar=c:\\fedora-3.0\\tomcat\\webapps\\fedora\\WEB-INF\\lib\\postgresql-8.2-506.jdbc3.jar
 
# Aspects of the original objects to ignore for the purpose of
# classification.  This is optional.  If unspecified, the generated
# content models will be the MOST SPECIFIC POSSIBLE.  If 
# specified, this property must consist of a space-delimited 
# list of any of the following:
# OrigContentModel
#  If specified, objects that have differing values in the original
#  contentModel property may be assigned to the same content
#  model if they are otherwise similar.
# DatastreamIDs
#  If specified, only datastreams bound to disseminators will
#  be considered important for classification.  Objects that have
#  differing sets of UNUSED datastream IDs may be assigned to
#  the same content model if they are otherwise similar.
# MIMETypes
#  If specified, the MIMETYPE of each candidate datastream
#  will be ignored for the purpose of classification.  Objects that
#  have differing MIME types for the same datastream may be
#  assigned to the same content model if they are otherwise
#  similar.
# FormatURIs
#  This works exactly the same as MIMETypes, but applies to
#  the FORMAT_URI of candidate datastreams.
#ignoreAspects=OrigContentModel DatastreamIDs MIMETypes FormatURIs
</pre>
              </code> 
            </span>
          </li>
 
          <li> Analyzer Usage
            <span class="plaintext">
              The analyzer utility is an executable jar and takes the 
              configuration file as a parameter.  For example, if your 
              configuration is in the current directory and is named 
              <code>migration.properties</code>, enter the following:
              <br/>
              <code class="block">
<pre>
java -jar analyzer.jar migration.properties
</pre>
              </code>
              <br/>
              Analysis of small repositories will finish very quickly.
              For repositories with millions of objects, analysis will take
              several hours.  With modern hardware, expect a rate of about 
              10,000 objects per minute.
            </span>
          </li>

          <li> Reviewing Analyzer Output
            <span class="plaintext">
              The analyzer will produce several files in the output 
              directory.
              <br/>
              <br/>
              Generated content models will be in FOXML 1.1 format and will
              be named cmodel-n.xml (where n is a number used for 
              association).  For each of these, there will be an associated
              cmodel-n.members.txt file containing a list of PIDs that 
              conform to the content model.
              <br/>
              <br/>
              Each content model object will contain the following inline 
              XML datastreams:
            </span>
            <ul>
              <li> <strong>CLASS-DESCRIPTION</strong> -
                   This is a simple human-readable log of the matching 
                   aspects of all member objects found during the analysis
                   process.  This datastream is not used or recognized by 
                   Fedora; it is only included for documentation purposes
                   and may be removed at any time.</li>
              <li> <strong>DS-COMPOSITE-MODEL</strong> -
                   This is a special Fedora-defined description of the 
                   datastreams (and aspects thereof) that member objects are 
                   expected to have.  You'll notice that it contains a 
                   subset of the information expressed in CLASS-DESCRIPTION.
                   This datastream is important, and should not be removed
                   from the content model object.</li>
            </ul>
            <span class="plaintext">
              If the member objects had disseminators:
            </span>
            <ul>
              <li> You will notice that the generated content model also has
                   a RELS-EXT datastream.  This RDF datastream points to the
                   original Behavior Definition objects via a Fedora-defined
                   hasBDef relationship.  This relationship means that 
                   members of this content model should have the behaviors
                   defined within the target BDef(s).</li>
              <li> There will also be an associated cmodel-n-bmechs.txt file
                   in the output directory.  For each Behavior Mechanism
                   formerly used by the objects' disseminators, this file
                   identifies the original BMech, specifies a PID for a new,
                   similar BMech, and specifies a set of datastream input
                   name changes that the copy should have.  This information
                   is used by the generator to create new 
                   content-model-specific Behavior Mechanism objects.</li>
            </ul>
            <span class="plaintext">
              Three additional files will be created in the output directory:
            </span>
            <ul>
              <li> <strong>bdefs.txt</strong> - this lists all original Behavior
                   Definition objects.  The generator will create a 
                   stylesheet to upgrade these objects to FOXML 1.1.</li>
              <li> <strong>bmechs.txt</strong> - this lists all original Behavior
                   Mechanism objects.  Although these objects will be made
                   obsolete by the new, generated Behavior Mechanisms,
                   the generator will create a stylesheet to upgrade them
                   to FOXML 1.1 so that you can view them in the 
                   Fedora 3.0 repository before deciding to purge them.</li>
              <li> <strong>nocmodel.txt</strong> - this lists objects that should 
                   NOT be assigned a content model.  Initially, the file is
                   empty but it can be customized, if desired (see 
                   <em>Upgrading Objects Without Content Models</em> below).
            </ul>
            <span class="plaintext">
            </span>
          </li>

          <li> Customizing Content Model PIDs
            <span class="plaintext">
              By default, the PIDs assigned to the generated content models 
              are of the form, <code>changeme:CModelN</code>.  You should
              change these to use your own repository's namespace.  You may
              also want to change the identifier part of the PID 
              (e.g. myns:Journal).
              <br/>
              <br/>
              To do this, open each cmodel-n.xml file in an editor and change
              the following as desired:
            </span>
            <ul>
              <li> The value of the PID attribute at the root of the
                   document.</li>
              <li> If there is a RELS-EXT datastream, change the part after
                   <code>info:fedora/</code> in the <code>rdf:about</code>
                   attribute.  For example, change 
                   <code>rdf:about="info:fedora/changeme:CModel1"</code> to 
                   <code>rdf:about="info:fedora/myorg:Journal"</code>.</li>
            </ul>
            <span class="plaintext">
            </span>
          </li>

          <li> Customizing Behavior Mechanism PIDs
            <span class="plaintext">
              If any cmodel-n-bmechs.txt files were created by the 
              analyzer, you should also change any NEW_BMECH pid values
              specified within each before continuing. These PIDs will default
              to values like <code>changeme:CModel1-BMech1</code>, but 
              again, you should specify your own (e.g. 
              <code>myns:Journal-BMech1</code>).
              <div class="notice">
                <strong>WARNING</strong>: DO NOT specify the same PID for 
                NEW_BMECH as OLD_BMECH, as this will cause ingest
                problems later.
              </div>
            </span>
          </li>
          <li> Upgrading Objects Without Content Models
            <span class="plaintext">
              By default, the analyzer ensures that every data object is
              assigned to a content model.  If you'd rather avoid 
              assigning an explicit content model to an object, you may
              do so by a) removing its PID from the cmodel-n-members.txt
              file in which it resides and b) adding it to the 
              nocmodel.txt file.  This may be done for any number of
              objects.
              <div class="notice">
                <strong>WARNING</strong>: In order for migration to work
                properly, the PID of every object in the source repository
                must occur exactly once in the set of PID list files.
              </div>
            </span>
          </li>
        </ol>
      </li>
      
      <li>
        <h2 id="generator">Run the Generator</h2>
        <span class="plaintext">
          The generator reads the output of the analyzer (along with any 
          customizations you have made) and adds the
          following to the same directory:
        </span>
        <ul>
          <li> New Behavior Mechanism objects (as specified in each
               cmodel-n-bmechs.txt file)</li>
          <li> Stylesheets for transforming existing objects as necessary</li>
        </ul>
        <span class="plaintext">
          <strong>NOTE</strong>: the generator does not make changes to the
          source objects.
        </span>
        <ol class="alpha">
          <li> Configuring the Generator
            <span class="plaintext">
              Like the analyzer, the generator accepts a Java properties
              file for configuration.
              <br/>
              <br/>
              The configuration file should have the following content,
              with values filled in appropriate to your environment.
              NOTE: Since you already entered fedoraHome and jdbcJar in 
              <code>migration.properties</code>, you can minimize typing 
              by just using that file, and adding the necessary sourceDir
              parameter as shown below.
              <br/>
              <code class="block">
<pre>
# This is the directory containing the analyzer's output, and where the generator's
# results should be written.
sourceDir=c:\\fedora-migration

# The Fedora 3.0 home directory
fedoraHome=c:\\fedora-3.0

# The full path to the JDBC driver Fedora is configured to use
jdbcJar=c:\\fedora-3.0\\tomcat\\webapps\\fedora\\WEB-INF\\lib\\postgresql-8.2-506.jdbc3.jar
</pre>
              </code>
            </span>
          </li>
          <li> Generator Usage
            <span class="plaintext">
              The generator utility also accepts the configuration file as a 
              parameter.  For example:
              <br/>
              <code class="block">
<pre>
java -jar generator.jar migration.properties
</pre>
              </code>
              <br/>
              The generator should finish very quickly, regardless 
              of the size of the repository.
            </span>
          </li>
          <li> Reviewing Generator Output
            <span class="plaintext">
              The generator will produce several files in the output 
              directory.  These files, along with those already produced by the
              analyzer, will be used in the next steps of the migration
              process.
              <br/>
              <br/>
              One stylesheet will be written for each PID list: bmechs.xslt,
              bdefs.xslt, nocmodel.xslt, and each cmodel-n.members.xslt
              file.  Each of these stylesheets will include transformation 
              rules for upgrading
              the objects to FOXML1.1 and adding the necessary 
              hasContentModel relationship via RELS-EXT, if necessary.
              NOTE: The generated stylesheet will cause a new RELS-EXT
              datastream to be created, or will amend the content of the
              latest revision of the RELS-EXT datastream, if it already exists.
              <br/>
              <br/>
              The output will also include a new, generated Behavior 
              Mechanism object (cmodel-n.bmechx.txt) for each one listed 
              in the input's cmodel-n.bmechs.txt files.  This BMech will
              match the content of the source BMech in the repository, 
              but it will have a different PID, will be in FOXML 1.1 format,
              and will use input part names consistent with the datastream 
              IDs specified in the associated content model's 
              DS-COMPOSITE-MODEL datastream.
            </span>
          </li>
        </ol>
      </li>
      
      <li>
        <h2 id="transformer">Run the Transformer</h2>
        <span class="plaintext">
          The transformer applies stylesheets to FOXML stored in a 
          Fedora repository.  Although it directly accepts the output of
          the analyzer and generator, it can also be used outside of the
          migration process for making low-level changes to batches of
          objects.  When running the transformer in this way, the 
          repository should be shut down, and the rebuilder should be
          run immediately afterward (see section below).
          <br/>
          <br/>
          Here's how the transformer works:  It scans a directory for PID
          list files, ending with .txt.  For each, if a .xslt file exists
          with the same name, that stylesheet is applied to the repository's
          FOXML for each object in the PID list.
          <div class="notice">
            <strong>WARNING</strong>: the transformer makes changes to 
            object XML in the repository.  It is possible to damage some, or
            all of the objects in the repository by using the transformer,
            so be sure to make a backup first!
          </div>
        </span>
        <ol class="alpha">
          <li> Configuring the Transformer
            <span class="plaintext">
              Like the analyzer and generator, the transformer accepts a
              Java properties file for configuration. The transformer is 
              configured with the same properties that the generator is
              configured with (see above), and also takes the following:
              <br/>
              <code class="block">
<pre>
# Whether to run the transformer in "dry run" mode or not.
# In dry run mode, transformation will be tested but no changes will be written
dryRun=true
</pre>
              </code>
              <br/>
              Although not required, it is strongly recommended that you 
              run the transformer with dryRun=true the first time, to ensure
              all transformations will fully succeed.
            </span>
          </li>
          <li> Transformer Usage
            <span class="plaintext">
              The transformer utility also takes the configuration file as 
              a parameter.  For example:
              <br/>
              <code class="block">
<pre>
java -jar transformer.jar migration.properties
</pre>
              </code>
              <br/>
              Transformation will take roughly double the time that analysis
              took, since it must read and write each file in the repository.
            </span>
          </li>
        </ol>
      </li>
      
      <li>
        <h2 id="rebuilder">Run the Rebuilder</h2>
        <span class="plaintext">
          Now that all of your existing objects have been upgraded, you 
          need to run the rebuilder so Fedora's database is up-to-date 
          with the files on disk.  See the 
          <a href="../server/cmd-line/index.html#rebuild">Rebuilder 
          Documentation</a> for further details.  NOTE: You MUST
          rebuild the SQL database.  Rebuilding the Resource Index is
          optional, and should be done only if your Fedora 3.0 instance
          has been configured to enable the Resource Index.
          <br/>
          <br/>
          Rebuilding the SQL database will take around double the time that
          the transformer took.  Rebuilding the Resource Index may take
          significantly longer.
        </span>
      </li>
      
      <li>
        <h2 id="ingest">Ingest Generated Objects</h2>
        <span class="plaintext">
          After the rebuilder has run successfully, you should restart 
          your Fedora 3.0 instance and visit the describe page 
          (e.g. <a href="http://localhost:8080/fedora/describe">
          http://localhost:8080/fedora/describe</a>) again to make sure it 
          started successfully.
          <br/>
          <br/>
          Now you'll need to ingest all the new Content Model 
          and Behavior Mechanism objects created during the 
          analyzer and generator steps.  To do this:
        </span>
        <ul>
          <li> Run fedora-admin.bat or fedora-admin.sh and login to your
               new repository from the local machine.</li>
          <li> Go to File -&gt; Ingest &gt; Objects from Directory, 
               and choose directory where these files were 
               written (e.g. <code>C:\fedora-migration</code>)</li>
          <li> Choose FOXML as the format, and OK.</li>
        </ul>
      </li>
      
      <li>
        <h2 id="verify">Verify Success and Clean Up</h2>
        <span class="plaintext">
          You should now verify that the upgraded objects are behaving
          as expected.  Pick a few from each cmodel-n.members.txt file
          and do the following for each:
        </span>
        <ul>
          <li> Visit the object's "Object Profile" page 
               (e.g. <a href="http://localhost:8080/fedora/get/demo:MyPID">
               http://localhost:8080/fedora/get/demo:MyPID</a>)</li>
          <li> From that page, navigate to "View Item Index", and click 
               each datastream, ensuring it downloads properly.</li>
          <li> If you had dissseminators in your original repository, 
               you should also navigate to the "View Dissemination Index"
               page and make sure your old disseminations appear, and 
               that they execute properly.</li>
        </ul>
        <span class="plaintext">
          If you had disseminators in your original repository, you are
          now making use of a NEW set of Behavior Mechanism objects.
          You may now want to purge the original BMechs, since they are
          no longer in use.  The simplest way to do this is with the 
          fedora-admin GUI:
        </span>
        <ul>
          <li> Run fedora-admin.bat or fedora-admin.sh and login to your
               new repository from the local machine.</li>
          <li> Go to Tools -&gt; Search, go into the advanced tab and add
               a condition that "fType" "equals" "M".</li>
          <li> Click OK and find your old Behavior Mechanism objects in
               the list.</li>
          <li> Select all the old ones (ctrl-click to select multiple),
               right-click and select "Purge Objects".</li>
        </ul>
      </li>
    </ol>
    
    <div id="footer">
      <p id="copyright">
        Copyright &copy; 2002-2007 Fedora Project
      </p>
      <script type="text/javascript">
        var cvsDate = "$Date: 2007-08-01 15:42:14 -0400 (Wed, 01 Aug 2007) $";
        var parts = cvsDate.split(" ");
        var modifiedDate = parts[1];
        var p = document.createElement("p");
        p.setAttribute("id", "lastModified");
        var footer = document.getElementById("footer");
        footer.appendChild(p);
        p.innerHTML = "Last Modified "+modifiedDate;
      </script>
    </div>
    
  </body>
</html>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
                      
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
  <head>
      <title>JUnit Testing in Fedora</title>
      <link rel="stylesheet" type="text/css" href="../../inc/css/docstyle.css" />
  </head>
  <body>
      
      <div id="header">
          <a href="../../index.html" id="logo"></a>
          <div id="title">
              <h1>JUnit Testing in Fedora</h1>
              <h2>Fedora Release 2.1</h2>
          </div>
      </div>
      
      <div id="toc">
          <h2>Table of Contents</h2>
          <div id="tocbox">
              <ol>
                  <li><a href="#intro">Introduction</a></li>
                  <li><a href="#writing">Writing Tests</a>
                      <ol>
                          <li><a href="#writing.object">Object tests</a></li>
                          <li><a href="#writng.end2end">End-to-End tests</a></li>
                      </ol>
                  </li>
                  <li><a href="#running">Running Tests</a>
                      <ol>
                          <li><a href="#running.ant">Ant</a></li>
                          <li><a href="#running.eclipse">Eclipse</a></li>
                      </ol>
                  </li>
              </ol>
          </div>
      </div>
      
      <div id="introduction">
          <h2><a name="intro">1. Introduction</a></h2>
          <p>This document describes writing and running JUnit tests for 
          Fedora. For a general introduction to unit testing or JUnit itself, 
          consult <a href="http://www.junit.org/">http://www.junit.org/</a>. 
          </p>
          
          <p>Test code is located in a separate source tree from production 
          code. The JUnit classes are located under <code>src/test/junit</code>.
          </p>
      </div>
      
      <div class="sect">
          <h2><a name="writing">2. Writing Tests</a></h2>
          <p>We can characterize the types of tests we will write as a spectrum 
          bounded by two extremes:</p>
              <ol>
                  <li>Object Tests</li>
                  <li>End-to-End Tests</li>
              </ol>
              
          <p>Object tests are tests of objects in isolation. An object is 
          instantiated, a method invoked, and the result is verified. End-to-
          end tests, on the other hand, test an entire application, from the 
          outside. The Fedora Test Plan tends towards tests on this end of the 
          spectrum.</p>
          
          <p>Generally, all the tests you write will be derived from the base 
          TestCase, <code>fedora.test.FedoraTestCase</code>. This base class 
          implements <code>FedoraTestConstants</code>, which defines a number of 
          useful test-related constants.</p>
          
          <div class="subsect">
              <h3><a name="writing.object">A. Writing Object Tests</a></h3>
              <p></p>
              
          </div>
          
          <div class="subsect">
              <h3><a name="writing.end2end">B. Writing End-to-End Tests</a></h3>
              <p>End-to-end (or integration) tests for Fedora typically require 
              a running instance of the Fedora Server. 
              Tests that require a running instance of the Fedora Server should 
              extend <code>FedoraServerTestCase</code> (which itself extends 
              <code>FedoraTestCase</code>). The setUp and tearDown methods of 
              <code>FedoraServerTestCase</code> start and stop a Fedora Server, 
              so be sure to call super() if you override setUp or tearDown.</p>
              
              <p>The following TestCase class will:
              <ol>
                  <li>start a Fedora Server</li>
                  <li>run <code>testExample1</code></li>
                  <li>stop the Fedora Server</li>
                  <li>start a Fedora Server</li>
                  <li>run <code>testExample2</code></li>
                  <li>stop the Fedora Server</li>
              </ol>
              </p>
              <div class="code"><pre>
package fedora.test.integration;

public class TestExampleA extends FedoraServerTestCase {
    public void testExample1() throws Exception {
        assertEquals("1", "1");
    }
    
    public void testExample2() throws Exception {
        String xml = "<galaxy><planet name='Earth'/></galaxy>";
        assertXpathExists("//planet[@name='Earth']", xml);
    }

    public static void main(String[] args) {
        junit.textui.TestRunner.run(TestAPIM.class);
    }

}</pre></div>

              <p>Note that in the preceding example, a Fedora Server is 
              started and stopped for each test case (i.e. once for 
              <code>testExample1</code> and again for 
              <code>testExample2)</code>. For many tests, this is neither 
              required nor desirable as starting an instance of Fedora is 
              relatively expensive (i.e. slow). Sharing a single Fedora Server
              between tests may be accomplished with an instance of 
              <code>FedoraServerTestSetup</code>.</p>
              
              <p>The general pattern is as follows:</p>
              <ol>
                  <li>Implement a custom <code>suite()</code> method in your 
                      <code>TestCase</code>.</li>
                  <li>Return an instance of <code>TestSetup</code> at the end 
                      of the <code>suite()</code> method.</li>
              </ol>                         
                  
              <div class="code"><pre>
package fedora.test.integration;

import org.custommonkey.xmlunit.SimpleXpathEngine;

public class TestExampleB extends FedoraServerTestCase {
    public static Test suite() {
        TestSuite suite = new TestSuite("Unit test for APIM");
        suite.addTestSuite(TestExampleB.class);
        return new FedoraServerTestSetup(suite);
    }
    
    public void setUp() throws Exception {
        TestIngestDemoObjects.ingestDemoObjects();
        SimpleXpathEngine.registerNamespace("dc", "http://purl.org/dc/elements/1.1/");
    }
    
    public void tearDown() throws Exception {
        SimpleXpathEngine.clearNamespaces();
        TestIngestDemoObjects.purgeDemoObjects();
    }
    
    public void testExample() throws Exception {
        assertEquals("1", "1");
    }
    
    public void testExample2() throws Exception {
        String xml = "<galaxy><planet name='Earth'/></galaxy>";
        assertXpathExists("//planet[@name='Earth']", xml);
    }
    
    public static void main(String[] args) {
        junit.textui.TestRunner.run(TestExampleB.class);
    }

}</pre></div>
              <p>The following extends the preceding pattern, allowing for a 
              setup and teardown that occurs once for an entire test run (i.e. 
              starting and stopping the Fedora Server), another setup and 
              teardown that occurs once for a given suite (e.g. ingesting and 
              purging demo objects), and yet another that occurs for each test 
              case.</p>
              <div class="code"><pre>                  
package fedora.test.integration;

import org.custommonkey.xmlunit.SimpleXpathEngine;

public class TestExampleC extends FedoraServerTestCase {
    public static Test suite() {
        TestSuite suite = new TestSuite("Unit test for APIM");
        suite.addTestSuite(TestExampleC.class);
        TestSetup wrapper = new TestSetup(suite) {
            public void setUp() {
                TestIngestDemoObjects.ingestDemoObjects();
            }
            
            public void tearDown() {
                TestIngestDemoObjects.purgeDemoObjects();
            }
        };
        return new FedoraServerTestSetup(wrapper);
    }
    
    public void setUp() throws Exception {
        System.out.println("once per test case setUp()");
    }
    
    public void tearDown() throws Exception {
        System.out.println("once per test case tearDown()");
    }
    
    public void testExample() throws Exception {
        assertEquals("1", "1");
    }
    
    public void testExample2() throws Exception {
        String xml = "<galaxy><planet name='Earth'/></galaxy>";
        assertXpathExists("//planet[@name='Earth']", xml);
    }
    
    public static void main(String[] args) {
        junit.textui.TestRunner.run(TestExampleC.class);
    }
}</pre></div>

              <p></p>

          </div>
          <div class="subsect">
              <h3><a name="writing.grouping">C. Grouping Tests</a></h3>
              <p><code>fedora.test.integration.AllTests</code> is the 
              grandfather of all Fedora integration tests. This is currently 
              the test that is called by the Ant junit target. All tests 
              that should be run as part of the test plan should be called by
              this test suite. Note that AllTests can call other test suites,
              so it's not necessary to individually list all the TestCases at 
              this level.</p>
          </div>
          
          <div class="subsect">
              <h3><a name="writing.config">D. Writing Configuration Tests</a></h3>
              <p>Testing multiple configurations of the Fedora Server is handled 
              through a combination of <code>Properties</code> files and 
              <code>fedora.test.integration.TestFedoraConfigurations</code>. 
              Properties files located in src/fcfg/server that are prefixed with 
              "junit" are applied against the base fedora.fcfg and then  run.</p>
              
              <div class="code"><pre>
# junit-mckoi.properties
module.fedora.server.storage.DOManager.storagePool                 = localMcKoiPool
module.fedora.server.search.FieldSearch.connectionPool             = localMcKoiPool
module.fedora.server.storage.ConnectionPoolManager.poolNames       = localMcKoiPool
module.fedora.server.storage.ConnectionPoolManager.defaultPoolName = localMcKoiPool
</pre></div>
              
          </div>
          
      </div>
      
      <div class="sect">
          <h2><a name="running">3. Running Tests</a></h2>
          <p>Running the Fedora server tests require that you have the 
          environment variable <code>FEDORA_HOME</code> correctly defined. For 
          testing, <code>FEDORA_HOME</code> should point to the 
          <code>dist</code> directory Ant creates when the <code>server</code> 
          target is invoked.</p>
          
          <p>In addition, the database you intend to run against should already 
          be up and running.</p>
          
          <p>Note that FedoraServerTestCase will delete the various filesystem 
          directories for the object, datastream, temp and resource index upon 
          completion. It will also drop the tables in the Fedora database.</p>
          
          <div class="subsect">
              <h3><a name="running.ant">A. Running Tests in Ant</a></h3>
              <p>Note: Ant 1.6 suffers from a JUnit affliction described at 
              <a href="http://ant.apache.org/faq.html#delegating-classloader">http://ant.apache.org/faq.html#delegating-classloader</a>.
              Ensuring junit.jar is in ANT_HOME/lib should do the trick.</p>
              <div class="code"><pre>
$ ant junit</pre></div>
              
              
          </div>
          
          <div class="subsect">
              <h3><a name="running.eclipse">B. Running Tests in Eclipse</a></h3>
              <p>You should have the following source directories configured: 
              <ul>
                  <li>src/java</li>
                  <li>src/properties/client</li>
                  <li>src/properties/server</li>
                  <li>src/test/junit</li>
                  <li>temp/generatedCode</li>
              </ul>                                
              </p>
          </div>
      </div>
      
      
      <div id="references" class="sect">
          <h2><a name="#references">6. References</a></h2>
          <dl>
              <dt><a name="xmlunit">[XMLUnit]</a></dt>
              <dd><a href="http://xmlunit.sourceforge.net/">bar</a></dd>
          </dl>
      </div>
      
      <div id="footer">
          <div id="copyright">
              Copyright &copy; 2005 Fedora Project
          </div>
          <div id="lastModified">
              Last Modified
              <script type="text/javascript">
                  var cvsDate = "$Date$";
                  var parts = cvsDate.split(" ");
                  var modifiedDate = parts[1];
                  document.write(modifiedDate);
              </script>
          </div>
      </div>
      
  </body>
</html>